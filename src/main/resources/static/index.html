<!DOCTYPE html>
<html lang="PT-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat em Tempo Real</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

    <h2>Chat em Tempo Real</h2>

    <div id="log"></div>

    <input type="text" id="username" placeholder="Seu Nome"><br>
    <div id="chat"></div>
    <input type="text" id="message" placeholder="Digite Sua Mensagem">
    <button onclick="sendMessage()">Enviar</button>
    <button onclick="finalizarChat()">Finalizar Chat</button>

    <script>
        let stompClient = null;

        // Fun√ß√£o para criar o log dos eventos
        function logMessage(text) {
            const log = document.getElementById("log");
            const p = document.createElement("p");
            p.textContent = text;
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
            console.log(text);
        }

        // Conectar ao WebSocket
        function connect() {
            const socket = new SockJS('/chat-websocket');
            stompClient = Stomp.over(socket);

            logMessage("üîÑ Conectando ao WebSocket...");

            stompClient.connect({}, function () {
                logMessage("‚úÖ Conectado com sucesso!");
                stompClient.subscribe('/topic/messages', function (messageOutput) {
                    const msg = JSON.parse(messageOutput.body);
                    showMessage(msg.sender + ": " + msg.content);
                });
            }, function (error) {
                logMessage("‚ùå Erro na conex√£o: " + error);
            });
        }

        // Enviar mensagem
        function sendMessage() {
            const sender = document.getElementById("username").value.trim();
            const content = document.getElementById("message").value.trim();

            if (!sender || !content) {
                alert("Preencha todos os campos!");
                return;
            }

            stompClient.send("/app/sendMessage", {}, JSON.stringify({
                'sender': sender,
                'content': content
            }));

            document.getElementById("message").value = '';
        }

        // Mostrar mensagens no chat
        function showMessage(message) {
            const chat = document.getElementById("chat");
            const p = document.createElement("p");
            p.textContent = message;
            chat.appendChild(p);
            chat.scrollTop = chat.scrollHeight;
        }

        // Finalizar chat e baixar hist√≥rico
        function finalizarChat() {
            const username = document.getElementById('username');
            const message = document.getElementById("message");
            const chat = document.getElementById("chat");
            const p = document.createElement("p");

            fetch('/chat/finalizar', { method: 'POST' })
            .then(response => {
                if(response.ok){
                    alert("Chat finalizado e arquivo salvo!");

                    // Baixar o hist√≥rico
                    const link = document.createElement('a');
                    link.href = '/chat/download';
                    link.download = 'chat_history.txt';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Desconectar WebSocket
                    if(stompClient) {
                        stompClient.disconnect();
                        logMessage("üõë Chat desconectado.");
                    }
                    

                    //Limpando os Campos de Chat
                    username.value = "";
                    message.value = "";
                    chat.value ="";
                    p.value = "";

                } else {
                    alert("Erro ao finalizar o chat.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao finalizar o chat.");
            });
        }

        // Conectar automaticamente ao carregar a p√°gina
        connect();
    </script>

</body>
</html>
